pipeline {
    agent any
    environment {
       OP_PATH = 'operator'
       INSTALL_MODE = ''
       CLEAN_MODE = 'FORCE'
    }

    stages {
        stage('Test') {
            steps {
                sh 'mkdir -p /root/.kube'
                sh 'echo ${KUBECONFIG} | base64 -d > /root/.kube/config'
                sh 'export KUBECONFIG=/root/.kube/config'
                sh 'sudo minikube start --vm-driver=none --extra-config=apiserver.v=4 --kubernetes-version=v1.14.0'
                sh 'sudo docker pull quay.io/operator-framework/operator-testing'
                sh 'sudo docker run -v ${HOME}/.kube/config:/root/.kube/config -v ${HOME}/.minikube:${HOME}/.minikube -v ${PWD}:${PWD} quay.io/operator-framework/operator-testing  operator.test --no-print-directory OP_PATH="${WORKSPACE}/${OP_PATH}" CLEAN_MODE=${CLEAN_MODE} INSTALL_MODE=${INSTALL_MODE} VERBOSE=1'
            }
        }
    }
   post {
        always {
            sh 'sudo minikube delete '
        }
    }
}
