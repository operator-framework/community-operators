
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-5.0.2" name="generator"/>
<title>Automate testing your Operator locally - Community operators</title>
<link href="../../assets/stylesheets/main.c1a4d03f.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#automate-testing-your-operator-locally">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Community operators" class="md-header-nav__button md-logo" href="../.." title="Community operators">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Community operators
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              Automate testing your Operator locally
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Type to start searching
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="https://github.com/operator-framework/community-operators/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    community-operators
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Community operators" class="md-nav__button md-logo" href="../.." title="Community operators">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z"></path></svg>
</a>
    Community operators
  </label>
<div class="md-nav__source">
<a class="md-source" href="https://github.com/operator-framework/community-operators/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    community-operators
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Overview">
      Overview
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" id="nav-2" type="checkbox"/>
<label class="md-nav__link" for="nav-2">
      Packaging your Operator for OperatorHub
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"></path></svg>
</span>
</label>
<nav aria-label="Packaging your Operator for OperatorHub" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-2">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</span>
        Packaging your Operator for OperatorHub
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../packaging-operator/" title="Operator structure">
      Operator structure
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../packaging-required-fields/" title="Required fields">
      Required fields
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      Testing
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"></path></svg>
</span>
</label>
<nav aria-label="Testing" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</span>
        Testing
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../testing-operators/" title="Explained">
      Explained
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../operator-test-suite/" title="Via test suite">
      Via test suite
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" id="nav-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4">
      Contributing
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"></path></svg>
</span>
</label>
<nav aria-label="Contributing" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-4">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</span>
        Contributing
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing-prerequisites/" title="Prerequisites">
      Prerequisites
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing-where-to/" title="Where to place operator">
      Where to place operator
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing-via-pr/" title="Creating pull request (PR)">
      Creating pull request (PR)
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tests-in-pr/" title="Tests in PR explained">
      Tests in PR explained
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../operator-versioning/" title="Updating existing Operators">
      Updating existing Operators
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../operator-overwrite/" title="Updating published Operator version">
      Updating published Operator version
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../operator-release-process/" title="Release process">
      Release process
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../best-practices/" title="Best practices">
      Best practices
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../troubleshooting/" title="Troubleshooting">
      Troubleshooting
    </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
    Prerequisites
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#available-test-modes">
    Available test modes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#troubleshooting">
    Troubleshooting
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#additional-shortcuts">
    Additional shortcuts
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/operator-framework/community-operators/edit/master/docs/legacy/using-obsolete-scripts.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"></path></svg>
</a>
<h1 id="automate-testing-your-operator-locally">Automate testing your Operator locally</h1>
<p>For convenience, in addition to the <a href="./testing-operators.md">manual test instructions</a> we provide a <code>Makefile</code> based test automation. This will automate all the manual steps referred to in <a href="./testing-operators.md#testing-operator-deployment-on-kubernetes">Testing Operator Deployment on Kubernetes</a>. In addition the <a href="https://github.com/operator-framework/operator-sdk/blob/master/doc/test-framework/scorecard.md"><code>scorecard</code></a> test from the Operator-SDK will be executed.
This is currently tested on <a href="https://github.com/kubernetes-sigs/kind">Kubernetes in Docker</a> but should work on other Kubernetes systems as well.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>You need the following installed on your local machine:</p>
<ul>
<li>Linux or macOS host</li>
<li>Docker</li>
<li>make</li>
<li>KIND (if no existing Kubernetes cluster is available via <code>KUBECONFIG</code> or in <code>~/.kube/config</code>)</li>
</ul>
<p><strong>Important:</strong> Notice, that this script uses a container to execute the test. Your <code>KUBECONFIG</code> will be bind mounted into the container. Therefore no config-helpers or references to files on your host machine are allowed. This is usually the case for <code>minikube</code> or GKE clusters.</p>
<p>All further dependencies are encapsulated in a container image that this <code>Makefile</code> will execute as a test driver.</p>
<h2 id="available-test-modes">Available test modes</h2>
<p>The <code>Makefile</code> supports two test modes. Both have these supported options:</p>
<h3>Options:</h3>
<p><code>OP_PATH</code> - relative path to your operator (required)</p>
<p><code>OP_VER</code> - version of operator (if not provided the latest will be determined from your <code>package.yaml</code>)</p>
<p><code>OP_CHANNEL</code> - channel of operator if is not provided it will be parsed by operator package yaml or use the default ones</p>
<p><code>VERBOSE</code> - enable verbose output of executed subcommands</p>
<h3>Linting metadata only</h3>
<p>Using <code>operator-courier</code>, this test verifies your CSV and the package definition. More details can be found in the <a href="https://github.com/operator-framework/operator-courier">docs</a>. As part of this test nothing will be changed on your system.</p>
<p>Example, run from the top-level directory of this repository:</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span> <span class="k">operator</span><span class="p">.</span><span class="n">verify</span> <span class="n">OP_PATH</span><span class="o">=</span><span class="n">upstream</span><span class="o">-</span><span class="n">community</span><span class="o">-</span><span class="n">operators</span><span class="o">/</span><span class="n">cockroachdb</span> <span class="k">VERBOSE</span><span class="o">=</span><span class="mi">1</span>

<span class="n">Pulling</span> <span class="n">docker</span> <span class="n">image</span>                              <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="k">Using</span> <span class="k">default</span> <span class="n">tag</span><span class="p">:</span> <span class="n">latest</span>
<span class="n">latest</span><span class="p">:</span> <span class="n">Pulling</span> <span class="k">from</span> <span class="n">dmesser</span><span class="o">/</span><span class="k">operator</span><span class="o">-</span><span class="n">testing</span>
<span class="n">Digest</span><span class="p">:</span> <span class="n">sha256</span><span class="p">:</span><span class="mi">457953575</span><span class="n">cd7bd2af60e55fb95f0413195e526c3bbe74b6de30faaf2f10a0585</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Image</span> <span class="k">is</span> <span class="n">up</span> <span class="k">to</span> <span class="nb">date</span> <span class="k">for</span> <span class="n">quay</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">dmesser</span><span class="o">/</span><span class="k">operator</span><span class="o">-</span><span class="n">testing</span><span class="p">:</span><span class="n">latest</span>
<span class="n">Pulling</span> <span class="n">docker</span> <span class="n">image</span>                              <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Lint</span> <span class="k">Operator</span> <span class="n">metadata</span>                            <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">csv</span> <span class="n">metadata</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">certified</span> <span class="k">not</span> <span class="k">defined</span><span class="p">.</span> <span class="p">[</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="o">/</span><span class="n">cockroachdb</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="n">clusterserviceversion</span><span class="p">.</span><span class="n">yaml</span><span class="p">]</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">csv</span> <span class="n">metadata</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">certified</span> <span class="k">not</span> <span class="k">defined</span><span class="p">.</span> <span class="p">[</span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">cockroachdb</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="n">clusterserviceversion</span><span class="p">.</span><span class="n">yaml</span><span class="p">]</span>
<span class="n">Lint</span> <span class="k">Operator</span> <span class="n">metadata</span>                            <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
</code></pre></div>
<h3>Deploying and Testing your Operator</h3>
<p>Using the <a href="https://github.com/operator-framework/operator-lifecycle-manager">Operator Lifecycle Manager</a> (OLM) your Operator will be packaged into a temporary catalog, containing all currently published community operators and yours. OLM will be installed for you if not present.</p>
<p>Using the current community catalog as a base allows you to test with dependencies on Operators currently published in this catalog. If you have dependencies outside of this catalog, you need to prepare your own cluster, install OLM, and ship a catalog with these dependencies present; otherwise installation will fail. 
You can provide a Kubernetes cluster as a testbed via <code>KUBECONFIG</code> or <code>~/.kube/confg</code>. If you have multiple cluster contexts configured in your <code>KUBECONFIG</code> you will be able to select one. If you have no cluster configured or reachable the Makefile will install a <code>kind</code> cluster named <code>operator-test</code> for you.</p>
<p>For this type of test, additionally the following options exist:</p>
<p><code>NO_KIND</code> - if set to <code>1</code> no attempt to bring up a kind cluster will be made. In this case you need to specify <code>CATALOG_IMAGE</code></p>
<p><code>CATALOG_IMAGE</code> - when <code>NO_KIND</code> is set to <code>1</code> you need to specify a container registry image location you have push privileges for and from which the image can be pulled again later by OLM without authentication. This parameter is ignored when <code>NO_KIND</code> is absent or set to <code>0</code> since the catalog image can be loaded directly into a KIND cluster.</p>
<p><code>CLEAN_MODE</code> - any of <code>NORMAL</code>, <code>NONE</code> and <code>FORCE</code>. As the test installs OLM components in your Kubernetes cluster this controls the clean up of those. In <code>NORMAL</code> clean up will happen if no errors occured. When set to <code>NONE</code> clean up is omitted. When set to <code>FORCE</code> clean up will always be done. Default is <code>NORMAL</code>.</p>
<p><code>INSTALL_MODE</code> - any of <code>OwnNamespace</code>, <code>SingleNamespace</code>, <code>AllNamespaces</code>. this controls the installation mode of the Operator and should be set according to what your Operator states as supported in the <code>installModes</code> section of the CSV. Default is <code>SingleNamepsace</code>.</p>
<p>You can start by just deploying your Operator:</p>
<div class="codehilite"><pre><span></span><code><span class="n">make</span> <span class="n">operator</span><span class="p">.</span><span class="n">install</span> <span class="n">OP_PATH</span><span class="o">=</span><span class="n">upstream</span><span class="o">-</span><span class="n">community</span><span class="o">-</span><span class="n">operators</span><span class="o">/</span><span class="n">cockroachdb</span>

<span class="n">Pulling</span> <span class="n">docker</span> <span class="n">image</span>                              <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Pulling</span> <span class="n">docker</span> <span class="n">image</span>                              <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Find</span> <span class="n">kube</span> <span class="n">config</span>                                  <span class="p">[</span>  <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">dmesser</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>  <span class="p">]</span>
<span class="n">Find</span> <span class="n">kube</span> <span class="n">cluster</span>                                 <span class="p">[</span>  <span class="n">Not</span> <span class="n">found</span>  <span class="p">]</span>
<span class="n">Start</span> <span class="n">KIND</span>                                        <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Start</span> <span class="n">KIND</span>                                        <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Building</span> <span class="n">catalog</span> <span class="n">image</span>                            <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Building</span> <span class="n">catalog</span> <span class="n">image</span>                            <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Operator</span> <span class="n">version</span> <span class="n">detected</span>                         <span class="p">[</span>  <span class="mf">1.7.2</span>  <span class="p">]</span>
<span class="n">Creating</span> <span class="n">namespace</span>                                <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Creating</span> <span class="n">namespace</span>                                <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Verify</span> <span class="n">operator</span>                                   <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Verify</span> <span class="n">operator</span>                                   <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Install</span> <span class="n">OLM</span>                                       <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Install</span> <span class="n">OLM</span>                                       <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Building</span> <span class="n">manifests</span>                                <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
<span class="n">Building</span> <span class="n">manifests</span>                                <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Operator</span> <span class="n">Deployment</span>                               <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
    <span class="n">Applying</span> <span class="n">object</span> <span class="n">to</span> <span class="n">cluster</span>                    <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
    <span class="n">Applying</span> <span class="n">object</span> <span class="n">to</span> <span class="n">cluster</span>                    <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
    <span class="n">Checking</span> <span class="k">if</span> <span class="n">subscriptions</span> <span class="n">passes</span>              <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
    <span class="n">Checking</span> <span class="k">if</span> <span class="n">subscriptions</span> <span class="n">passes</span>              <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
    <span class="n">Checking</span> <span class="k">if</span> <span class="n">CSV</span> <span class="n">passes</span>                        <span class="p">[</span>  <span class="n">Processing</span>  <span class="p">]</span>
    <span class="n">Checking</span> <span class="k">if</span> <span class="n">CSV</span> <span class="n">passes</span>                        <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
<span class="n">Operator</span> <span class="n">Deployment</span>                               <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
</code></pre></div>
<p>This way you can test if your Operator is packaged correctly.</p>
<p>You can also run a test that will deploy your Operator and checks if it behaves correctly according to <code>scorecard</code> (which is part of the Operator-SDK). <code>scorecard</code> will use the example CRs defined in <code>metadata.annotations.alm-examples</code> in the CSV to try to use your Operator and observe its behavior.</p>
<p>Example, run from the top-level directory of this repository:</p>
<div class="codehilite"><pre><span></span><code><span class="k">[...]</span>

<span class="na">make operator.test OP_PATH</span><span class="o">=</span><span class="s">upstream-community-operators/cockroachdb</span>

<span class="k">[...]</span>
<span class="na">Instrumenting Operator for test                   [  Processing  ]</span>
    <span class="na">creating CR files                             [  Processing  ]</span>
    <span class="na">creating CR files                             [  OK  ]</span>
    <span class="na">injecting scorecard proxy                     [  Processing  ]</span>
    <span class="na">injecting scorecard proxy                     [  OK  ]</span>
<span class="na">Instrumenting Operator for test                   [  OK  ]</span>
<span class="na">Running scorecard trough all supplied CRs         [  Processing  ]</span>
    <span class="na">Running required tests                        [  Processing  ]</span>
    <span class="na">Running required tests                        [  OK  ]</span>
    <span class="na">Running recommended tests                     [  Processing  ]</span>
    <span class="na">Running recommended tests                     [  OK  ]</span>
    <span class="na">Running required tests                        [  Processing  ]</span>
    <span class="na">Running required tests                        [  OK  ]</span>
    <span class="na">Running recommended tests                     [  Processing  ]</span>
    <span class="na">Running recommended tests                     [  OK  ]</span>
<span class="na">Running scorecard trough all supplied CRs         [  OK  ]</span>
<span class="na">Cleaning up Operator resources                    [  Processing  ]</span>
<span class="na">Cleaning up Operator resources                    [  OK  ]</span>
<span class="na">Cleaning up Operator definition                   [  Processing  ]</span>
<span class="na">Cleaning up Operator definition                   [  OK  ]</span>
<span class="na">Cleaning up namespace                             [  Processing  ]</span>
<span class="na">Cleaning up namespace                             [  OK  ]</span>
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Here are some common scenarios, why your test can fail:</p>
<h3>Failures when linting Operator metadata</h3>
<p><code>ERROR: metadata.annotations.alm-examples contains invalid json string [1.4.4/my-operator.v1.4.4.clusterserviceversion.yaml]</code></p>
<p>The linter checks for valid JSON in <code>metadata.annotations.alm-examples</code>. The rest of the CSV is supposed to be YAML.</p>
<h3>Failures when loading the Operator into the Community Catalog</h3>
<p><code>my-operator.v2.1.11 specifies replacement that couldn't be found</code></p>
<p>Explanation: This happens because the catalog cannot load your Operator since it's pointing to a non-existent previous version of your Operator using <code>spec.replaces</code>. For updates, it is important that this property points to another, older version of your Operator that is already in the catalog.</p>
<p><code>error adding operator bundle : error decoding CRD: no kind \"CustomResourceDefinition\" is registered for version \"apiextensions.k8s.io/v1\" in scheme \"pkg/registry/bundle.go</code></p>
<p>Explanation: Currently OLM does not yet support handling CRDs using <code>apiextensions.k8s.io/v1</code>. This will improve soon. Until then you need to resort back to <code>apiextensions.k8s.io/v1beta</code>.</p>
<p><code>error loading manifests from directory: error checking provided apis in bundle : couldn't find charts.someapi.k8s.io/v1alpha1/myapi (my-custom-resource) in bundle. found: map[]</code></p>
<p>Explanation: Your Operator claims ownership of a CRD that it does not ship. Check for spelling of Group/Version/Kind in <code>spec.customresourcedefinitions.owned</code> in the CSV.</p>
<p><code>error loading package into db: [FOREIGN KEY constraint failed, no default channel specified for my-operator]</code></p>
<p>Explanation: This happens when either
- Your Operator package defines more than one channel in <code>package.yaml</code> but does not define <code>defaultChannel</code>.
- The package just defines a single channel (in which case you can omit <code>defaultChannel</code>) but the catalog couldn't load the CSV that this channel points to using <code>currentCSV</code>. This can happen when in the CSV the specified name in <code>metadata.name</code> is actually different from what <code>currentCSV</code> points to.</p>
<h3>Failures when deploying via OLM</h3>
<p><code>Check if subscription passes</code> times out</p>
<p>Explanation: In this case the <code>Subscription</code> object created by the test suite did not transition to the state <code>AtLatestKnown</code> before hitting a timeout. There are various reasons for this, ranging from the catalog pod crashing to problems with the <code>catalog-operator</code> pod of OLM itself. In any case, the logs of either pod will likely help troubleshooting and finding the root cause.</p>
<p><code>Check if CSV passes</code> times out</p>
<p>Explanation: OLM could not install the Operator's <code>Deployment</code> from its CSV before hitting a timeout. This is usually due to <code>Deployment</code> reaching its expected replica count, likely because the pod is crash-looping.</p>
<h3>Failures during tests of the Operator with Operator-SDK scorecard</h3>
<p><code>failed to get proxyPod: timed out waiting for the condition:</code></p>
<p>Explanation: If this happened it is likely the Operator pod crashed in the middle of the scorecard test suite. For example, when it failed to parse a Custom Resource fed to scorecard from the list in <code>metadata.annotations.alm-examples</code>. OLM will wait for the <code>Deployment</code> of the Operator to recover before re-installing the Operator. Re-installation changes the Operator pod's name and hence scorecard fails to reach the logs of scorecard proxy using its old name.</p>
<p><code>failed to create cr resource: object is being deleted: someapi.k8s.io "myCRD" already exists:</code></p>
<p>Explanation: This can happen when your Operator automatically creates a CR on startup, with the same name of an example for that CR provided in the CSV <code>metadata.annotations.alm-examples</code> section. Simply use a different name in the example. Otherwise, your Operator could be slow to delete a CR due to a finalizer.</p>
<h2 id="additional-shortcuts">Additional shortcuts</h2>
<h3>Clean up after a failed test</h3>
<p>As explained above, the default <code>CLEAN_MODE</code> of <code>NORMAL</code> will delete anything that got installed on your cluster if all tests run correctly.. If something fails, the deployed resources will not be deleted in order to give you a chance to debug.
After you have finished debugging you can use the following command to clean up any residual resources as part of a test of a particular Operator:</p>
<div class="codehilite"><pre><span></span><code><span class="err">make operator.cleanup OP_PATH=upstream-community-operators/cockroachdb</span>
</code></pre></div>
<h3>Install a KIND cluster</h3>
<p>Install a <code>kind</code> cluster as a testbed for the Operator deployment.</p>
<div class="codehilite"><pre><span></span><code>$ kind create cluster --name operator-test
</code></pre></div>
<p>This command will create a Kubernetes in Docker cluster:</p>
<div class="codehilite"><pre><span></span><code>$ kind get clusters                     
operator-test

$ kind get nodes --name operator-test
operator-test-control-plane
</code></pre></div>
<h3>Install Operator Lifecycle Manager</h3>
<p>Install OLM to an existing cluster (determined via <code>KUBECONFIG</code> or <code>~/.kube/config</code>).</p>
<div class="codehilite"><pre><span></span><code><span class="err">make olm.install</span>
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/vendor.606193c2.min.js"></script>
<script src="../../assets/javascripts/bundle.b90b6d1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
<script>
        app = initialize({
          base: "../..",
          features: ["navigation.tabs", "navigation.sections", "navigation.expand", "toc.integrate"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
</body>
</html>