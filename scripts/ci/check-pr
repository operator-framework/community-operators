#!/usr/bin/env bash

set -e

DIRS=()
GIT_INFO=""

if [[ "$1" == "openshift" ]]; then
  DIRS=( "community-operators" )
  GIT_INFO=master
else
  DIRS=( "upstream-community-operators" )
  GIT_INFO="$TRAVIS_COMMIT_RANGE"
  # Make sure the TRAVIS_COMMIT_RANGE is valid, by catching any errors and exiting.
  if [[ -z "$GIT_INFO" ]] || ! git rev-list --quiet $GIT_INFO; then
    echo "Invalid commit range."
    exit 0
  fi
fi

# Only run CI if an operator package was modified.
if ! git diff --name-only $GIT_INFO | grep -q '\.yaml'; then
  echo "Only non-manifest files were updated, not running the CI."
  exit 0
fi

# Only run CI on changes to certain directories.
IS_TESTABLE=1
for d in "${DIRS[@]}"; do
  if git diff --name-only $GIT_INFO | grep -q "$d"; then
    IS_TESTABLE=0
    break
  fi
done
if [[ $IS_TESTABLE -gt 0 ]]; then
  echo "No testable operators were updated, not running the CI."
  exit 0
fi
